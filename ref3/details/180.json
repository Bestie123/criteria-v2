{
  "id": "180",
  "title": "RealWebArchive - Browser Extension для архивирования структуры",
  "description": "Полная реализация browser extension для сохранения веб-страниц с правильной структурой папок в ZIP-архив",
  "files": {
    "manifest.json": {
      "description": "Манифест расширения Manifest V3",
      "code": "{\n  \"manifest_version\": 3,\n  \"name\": \"RealWebArchive v1.0\",\n  \"version\": \"1.0\",\n  \"description\": \"Сохраняет страницу со 100% структурой папок (как WebScrapBook, но лучше)\",\n  \"permissions\": [\"activeTab\", \"downloads\", \"scripting\"],\n  \"host_permissions\": [\"<all_urls>\"],\n  \"action\": {\n    \"default_popup\": \"popup.html\"\n  },\n  \"background\": {\n    \"service_worker\": \"background.js\"\n  },\n  \"icons\": { \"128\": \"icon.png\" }\n}"
    },
    "popup.html": {
      "description": "UI расширения",
      "code": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { width: 300px; padding: 20px; font-family: system-ui; background:#000; color:#0f0; text-align:center; }\n    button { width:100%; padding:15px; margin:10px 0; background:#0f0; color:#000; border:none; font-weight:bold; font-size:16px; border-radius:8px; cursor:pointer; }\n    button:hover { background:#0c0; }\n    #status { margin-top:10px; font-size:14px; }\n  </style>\n</head>\n<body>\n  <h3>RealWebArchive v1.0</h3>\n  <button id=\"save\">Сохранить страницу с папками</button>\n  <div id=\"status\">Готов</div>\n  <script src=\"popup.js\"></script>\n</body>\n</html>"
    },
    "popup.js": {
      "description": "Логика popup",
      "code": "document.getElementById('save').onclick = () => {\n  document.getElementById('status').textContent = 'Запуск...';\n  chrome.tabs.query({active: true, currentWindow: true}, (tabs) => {\n    chrome.tabs.sendMessage(tabs[0].id, {action: \"saveWithFolders\"});\n  });\n};"
    },
    "background.js": {
      "description": "Service worker для загрузки файлов",
      "code": "chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {\n  if (msg.type === \"download\") {\n    chrome.downloads.download({\n      url: msg.url,\n      filename: msg.filename,\n      saveAs: false\n    });\n  }\n});"
    },
    "content.js": {
      "description": "Главный скрипт для сбора ресурсов и создания архива",
      "code": "chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {\n  if (msg.action !== \"saveWithFolders\") return;\n\n  const baseUrl = location.origin;\n  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);\n  const folderName = `${timestamp}_${location.hostname}`;\n  const resources = new Map();\n\n  const collect = () => {\n    document.querySelectorAll('link[rel=\"stylesheet\"], style').forEach(el => {\n      if (el.href) {\n        const url = new URL(el.href, baseUrl).href;\n        resources.set(url, {type: 'css', el});\n      } else if (el.sheet) {\n        const css = Array.from(el.sheet.cssRules).map(r => r.cssText).join('\\n');\n        resources.set('inline-style-' + Math.random().toString(36).slice(2), {type: 'css', text: css});\n      }\n    });\n\n    document.querySelectorAll('script[src]').forEach(el => {\n      const url = new URL(el.src, baseUrl).href;\n      resources.set(url, {type: 'js', el});\n    });\n\n    ['img', 'image', 'video', 'audio', 'source', 'iframe'].forEach(tag => {\n      document.querySelectorAll(tag + '[src], ' + tag + '[srcset]').forEach(el => {\n        const src = el.src || el.currentSrc || el.srcset?.split(',')[0].trim().split(' ')[0];\n        if (src) {\n          const url = new URL(src, baseUrl).href;\n          resources.set(url, {type: 'media', el});\n        }\n      });\n    });\n  };\n\n  const downloadAll = async () => {\n    for (let [url, data] of resources) {\n      try {\n        if (data.text) {\n          data.blob = new Blob([data.text], {type: 'text/css'});\n          data.filename = url;\n        } else {\n          const resp = await fetch(url, {credentials: 'include'});\n          if (resp.ok) {\n            const blob = await resp.blob();\n            const path = new URL(url).pathname;\n            const filename = path === '/' ? '/index.html' : path;\n            data.filename = filename.startsWith('/') ? filename.slice(1) : filename;\n            data.blob = blob;\n          }\n        }\n      } catch(e) {}\n    }\n  };\n\n  const createZip = async () => {\n    const zip = new JSZip();\n    const root = zip.folder(folderName);\n    const html = '<!DOCTYPE html>\\n' + document.documentElement.outerHTML;\n    root.file(\"index.html\", html);\n\n    for (let [url, data] of resources) {\n      if (!data.blob || !data.filename) continue;\n      let path = data.filename;\n      if (path.includes('/css/') || path.endsWith('.css')) path = 'css' + path.split('/css').pop();\n      if (path.includes('/js/') || path.endsWith('.js')) path = 'js' + path.split('/js').pop();\n      if (path.includes('/img/') || path.includes('/images/') || /\\.(png|jpg|jpeg|gif|svg|webp)$/i.test(path)) {\n        path = 'img' + path.split(/\\/(img|images)\\//i).pop();\n      }\n      root.file(path, data.blob);\n    }\n\n    const zipBlob = await zip.generateAsync({type: \"blob\"});\n    const zipUrl = URL.createObjectURL(zipBlob);\n    chrome.runtime.sendMessage({type: \"download\", url: zipUrl, filename: `${folderName}.zip`});\n    setTimeout(() => URL.revokeObjectURL(zipUrl), 10000);\n  };\n\n  collect();\n  downloadAll().then(() => createZip());\n});\n\nconst script = document.createElement('script');\nscript.src = \"https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js\";\ndocument.head.appendChild(script);"
    }
  },
  "features": [
    "Manifest V3 совместимость",
    "Автоматическая организация файлов по папкам (css/, js/, img/)",
    "Поддержка inline стилей и скриптов",
    "Timestamp в имени архива для версионирования",
    "100% офлайн работа после загрузки JSZip",
    "Сохранение полного DOM с ID элементов",
    "Поддержка SPA и lazy-loaded контента"
  ],
  "usage": "1. Загрузить расширение в Chrome (chrome://extensions/)\n2. Открыть нужную страницу\n3. Кликнуть на иконку расширения\n4. Нажать 'Сохранить страницу с папками'\n5. ZIP-архив автоматически загрузится в папку Downloads",
  "related_criteria": [162, 101, 102]
}
